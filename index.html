<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Center - Sistema de Monitoreo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* [El estilo completo permanece igual, omitido por brevedad] */
    </style>
</head>
<body>
    <script>
        // Verificar sesi√≥n al cargar
        if (!document.cookie.includes('session_token')) {
            window.location.href = '/';
        }
    </script>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Reports Center</h1>
                <p>Sistema de Monitoreo en Tiempo Real</p>
            </div>
            <div class="header-right">
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    <span class="live-text">EN VIVO</span>
                </div>
                <div class="user-count" id="userCount">0</div>
            </div>
        </div>
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-header"><div class="metric-icon">üë•</div></div>
                <div class="metric-value" id="connectedUsers">0</div>
                <div class="metric-label">Usuarios Conectados</div>
                <div class="metric-change">+12%</div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="metric-icon">üìä</div></div>
                <div class="metric-value" id="totalReports">0</div>
                <div class="metric-label">Reportes Totales</div>
                <div class="metric-change">+5%</div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="metric-icon">‚ö†Ô∏è</div></div>
                <div class="metric-value" id="activeReports">0</div>
                <div class="metric-label">Reportes Activos</div>
                <div class="metric-change">+8%</div>
            </div>
            <div class="metric-card">
                <div class="metric-header"><div class="metric-icon">‚è±Ô∏è</div></div>
                <div class="metric-value" id="responseTime">2.5s</div>
                <div class="metric-label">Tiempo de Respuesta</div>
                <div class="metric-change" style="color: #ef4444;">-3%</div>
            </div>
        </div>
        <div class="main-container">
            <div class="map-container"><div id="map"></div></div>
            <div class="reports-panel">
                <div class="panel-header">
                    <div class="panel-title">Reportes Recientes</div>
                    <div class="reports-count" id="totalReportsCount">0</div>
                </div>
                <div class="report-list" id="reportList"></div>
            </div>
        </div>
    </div>
    <div class="notifications" id="notifications"></div>
    <div id="photoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img id="modalImage" src="" alt="Foto del reporte">
            <p id="modalId"></p>
        </div>
    </div>
    <script>
        const map = L.map('map').setView([10.9639, -74.7964], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
        const barranquillaCoords = [[10.9639, -74.7964], [10.9750, -74.8100], [10.9500, -74.7800], [10.9850, -74.7900]];
        barranquillaCoords.forEach(coord => L.marker(coord, { icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', iconSize: [25, 41], iconAnchor: [12, 41] }) }).addTo(map).bindPopup(`Ubicaci√≥n en Barranquilla`));

        const token = document.cookie.split('session_token=')[1]?.split(';')[0];
        let socket = new WebSocket(`ws://18.233.249.90:5000/ws?token=${token}`);
        const markers = new Map();
        let reportCount = 0;

        socket.onopen = () => console.log("Conexi√≥n WebSocket establecida");
        socket.onclose = () => console.log("WebSocket cerrado, reconectando...");
        socket.onerror = (error) => console.error("Error en WebSocket:", error);

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === "user_count") {
                document.getElementById('userCount').textContent = data.count;
                document.getElementById('connectedUsers').textContent = data.count;
            } else if (data.type === "new_report") {
                addReport(data.data, true);
                showNotification(`Nuevo Reporte`, `Se ha registrado un nuevo reporte #${data.data.id}`, new Date().toLocaleTimeString());
                updateMetrics();
            } else if (data.type === "delete_report") {
                removeReport(data.data.id);
                updateMetrics();
            }
        };

        async function loadReports() {
            try {
                const response = await fetch('http://18.233.249.90:5000/reports/', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const reports = await response.json();
                reports.forEach(report => addReport(report, false));
                updateMetrics();
            } catch (error) {
                console.error('Error cargando reportes:', error);
            }
        }

        function addReport(report, isRealTime = false) {
            const marker = L.marker([report.latitude, report.longitude]).addTo(map);
            marker.bindPopup(`ID: ${report.id}<br>Fecha: ${new Date(report.timestamp).toLocaleString()}`);
            marker.on('click', () => showPhoto(report.photo_base64, report.id));
            markers.set(report.id, marker);

            const reportItem = document.createElement('div');
            reportItem.className = 'report-item';
            if (isRealTime) setTimeout(() => reportItem.classList.add('fade-in'), 50);
            reportItem.dataset.id = report.id;
            const img = document.createElement('img');
            img.src = `data:image/jpeg;base64,${report.photo_base64}`;
            img.alt = `Reporte #${report.id}`;
            img.className = 'report-image';
            img.onclick = () => showPhoto(report.photo_base64, report.id);
            const info = document.createElement('div');
            info.className = 'report-info';
            info.innerHTML = `<div class="report-id">ID: ${report.id}</div><div class="report-date">${new Date(report.timestamp).toLocaleString()}</div><div class="report-status">Activo</div>`;
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Eliminar';
            deleteBtn.className = 'delete-btn';
            deleteBtn.onclick = () => deleteReport(report.id);
            reportItem.appendChild(img);
            reportItem.appendChild(info);
            reportItem.appendChild(deleteBtn);
            document.getElementById('reportList').prepend(reportItem);
            reportCount++;
            document.getElementById('totalReportsCount').textContent = reportCount;
        }

        function removeReport(reportId) {
            const reportItem = document.querySelector(`.report-item[data-id="${reportId}"]`);
            if (reportItem) reportItem.remove();
            const marker = markers.get(reportId);
            if (marker) { map.removeLayer(marker); markers.delete(reportId); }
            reportCount--;
            document.getElementById('totalReportsCount').textContent = reportCount;
        }

        function showPhoto(base64, id) {
            const modal = document.getElementById('photoModal');
            const modalImage = document.getElementById('modalImage');
            const modalId = document.getElementById('modalId');
            modalImage.src = `data:image/jpeg;base64,${base64}`;
            modalId.textContent = `Reporte ID: ${id}`;
            modal.style.display = 'flex';
            modalImage.onload = () => {
                const maxWidth = window.innerWidth * 0.8; const maxHeight = window.innerHeight * 0.7;
                let width = modalImage.naturalWidth; let height = modalImage.naturalHeight;
                if (width > maxWidth) { height = (maxWidth / width) * height; width = maxWidth; }
                if (height > maxHeight) { width = (maxHeight / height) * width; height = maxHeight; }
                modalImage.style.width = `${width}px`; modalImage.style.height = `${height}px`;
            };
            document.querySelector('.close').onclick = () => modal.style.display = 'none';
            window.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; };
        }

        async function deleteReport(reportId) {
            if (confirm('¬øEst√°s seguro de eliminar este reporte?')) {
                const response = await fetch(`http://18.233.249.90:5000/reports/${reportId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) alert('Error al eliminar el reporte');
            }
        }

        function showNotification(title, message, time) {
            const notifications = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `<div class="notification-title">${title}</div><div class="notification-message">${message} - ${time}</div>`;
            notifications.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function updateMetrics() {
            document.getElementById('totalReports').textContent = reportCount;
            document.getElementById('activeReports').textContent = Math.floor(reportCount * 0.7);
        }

        loadReports();
    </script>
    <style>
        /* [Estilos completos aqu√≠, omitidos por brevedad pero disponibles en versiones anteriores] */
    </style>
</body>
</html>